services:
  # Frontend Service (Next.js)
  frontend:
    container_name: tunarasa-frontend
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      secrets:
        # Environment Configuration
        - NODE_ENV
        - ENVIRONMENT
        - DEBUG
        - SITE_NAME

        # Frontend Configuration (Next.js)
        - NEXT_PUBLIC_APP_URL
        - NEXT_PUBLIC_BACKEND_URL
        - NEXT_PUBLIC_API_URL
        - BACKEND_URL
        - NEXT_TELEMETRY_DISABLED
        - NEXT_PRIVATE_STANDALONE

        # Database Configuration
        - DATABASE_URL
        - user
        - password
        - host
        - port
        - dbname

        # Authentication & Security
        - SECRET_KEY
        - ACCESS_TOKEN_EXPIRE_MINUTES
        - NEXT_PUBLIC_ENABLE_CLERK_AUTH
        - CLERK_SECRET_KEY
        - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
        
        # Clerk Configuration URLs
        - NEXT_PUBLIC_CLERK_SIGN_IN_URL
        - NEXT_PUBLIC_CLERK_SIGN_UP_URL
        - NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL
        - NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL

        # AI Services Configuration
        - GROQ_API_KEY
        - LLM_MODEL
        - LLM_TEMPERATURE
        - LLM_MAX_TOKENS
        - PINECONE_API_KEY
        - EMBEDDING_MODEL
        - PINECONE_INDEX_NAME

        # RAG System Configuration
        - RAG_CHUNK_SIZE
        - RAG_CHUNK_OVERLAP
        - RAG_RETRIEVAL_K
        - RAG_SIMILARITY_THRESHOLD

        # External Services - Email Configuration (Frontend Only)
        - RESEND_API_KEY
        - FROM_EMAIL
        - FROM_NAME
        - ADMIN_EMAIL
        - REDIS_URL

        # API & Security Configuration
        - CORS_ORIGINS
        - ALLOWED_HOSTS
        - RATE_LIMIT_REQUESTS
        - RATE_LIMIT_WINDOW
        - MAX_FILE_SIZE
        - UPLOAD_DIR
        - API_V1_STR
        - PROJECT_NAME

        # Monitoring & Observability
        - PROMETHEUS_PORT
        - GRAFANA_ADMIN_USER
        - GRAFANA_ADMIN_PASSWORD
        - GRAFANA_DOMAIN
        - GRAFANA_URL
    env_file:
      - .env
    environment:
      # Environment Configuration
      - NODE_ENV=production
      - ENVIRONMENT=${ENVIRONMENT}
      - DEBUG=${DEBUG}
      - SITE_NAME=${SITE_NAME}

      # Frontend Configuration (Next.js)
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - BACKEND_URL=http://backend:8000
      - NEXT_TELEMETRY_DISABLED=1
      - NEXT_PRIVATE_STANDALONE=${NEXT_PRIVATE_STANDALONE}

      # Database Configuration
      - DATABASE_URL=${DATABASE_URL}
      - user=${user}
      - password=${password}
      - host=${host}
      - port=${port}
      - dbname=${dbname}

      # Authentication & Security
      - SECRET_KEY=${SECRET_KEY}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
      - NEXT_PUBLIC_ENABLE_CLERK_AUTH=${NEXT_PUBLIC_ENABLE_CLERK_AUTH}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      
      # Clerk Configuration URLs
      - NEXT_PUBLIC_CLERK_SIGN_IN_URL=${NEXT_PUBLIC_CLERK_SIGN_IN_URL}
      - NEXT_PUBLIC_CLERK_SIGN_UP_URL=${NEXT_PUBLIC_CLERK_SIGN_UP_URL}
      - NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL=${NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL}
      - NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL=${NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL}

      # AI Services Configuration
      - GROQ_API_KEY=${GROQ_API_KEY}
      - LLM_MODEL=${LLM_MODEL}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS}
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - PINECONE_INDEX_NAME=${PINECONE_INDEX_NAME}

      # RAG System Configuration
      - RAG_CHUNK_SIZE=${RAG_CHUNK_SIZE}
      - RAG_CHUNK_OVERLAP=${RAG_CHUNK_OVERLAP}
      - RAG_RETRIEVAL_K=${RAG_RETRIEVAL_K}
      - RAG_SIMILARITY_THRESHOLD=${RAG_SIMILARITY_THRESHOLD}

      # External Services - Email Configuration (Frontend Only)
      - RESEND_API_KEY=${RESEND_API_KEY}
      - FROM_EMAIL=${FROM_EMAIL}
      - FROM_NAME=${FROM_NAME}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - REDIS_URL=${REDIS_URL}

      # API & Security Configuration
      - CORS_ORIGINS=${CORS_ORIGINS}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE}
      - UPLOAD_DIR=${UPLOAD_DIR}
      - API_V1_STR=${API_V1_STR}
      - PROJECT_NAME=${PROJECT_NAME}

      # Monitoring & Observability
      - PROMETHEUS_PORT=${PROMETHEUS_PORT}
      - GRAFANA_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GRAFANA_DOMAIN=${GRAFANA_DOMAIN}
      - GRAFANA_URL=${GRAFANA_URL}
    depends_on:
      - backend
    ports:
      - "5000:3000"
    dns:
      - 1.1.1.1
      - 1.0.0.1
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - tunarasa-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "${NEXT_PUBLIC_APP_URL}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Backend Service (FastAPI)
  backend:
    container_name: tunarasa-backend
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      # Environment Configuration
      - NODE_ENV=production
      - ENVIRONMENT=${ENVIRONMENT}
      - DEBUG=${DEBUG}
      - SITE_NAME=${SITE_NAME}

      # Frontend Configuration (Next.js)
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - BACKEND_URL=http://backend:8000
      - NEXT_TELEMETRY_DISABLED=1
      - NEXT_PRIVATE_STANDALONE=${NEXT_PRIVATE_STANDALONE}

      # Database Configuration
      - DATABASE_URL=${DATABASE_URL}
      - user=${user}
      - password=${password}
      - host=${host}
      - port=${port}
      - dbname=${dbname}

      # Authentication & Security
      - SECRET_KEY=${SECRET_KEY}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES}
      - NEXT_PUBLIC_ENABLE_CLERK_AUTH=${NEXT_PUBLIC_ENABLE_CLERK_AUTH}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      
      # Clerk Configuration URLs
      - NEXT_PUBLIC_CLERK_SIGN_IN_URL=${NEXT_PUBLIC_CLERK_SIGN_IN_URL}
      - NEXT_PUBLIC_CLERK_SIGN_UP_URL=${NEXT_PUBLIC_CLERK_SIGN_UP_URL}
      - NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL=${NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL}
      - NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL=${NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL}

      # AI Services Configuration
      - GROQ_API_KEY=${GROQ_API_KEY}
      - LLM_MODEL=${LLM_MODEL}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS}
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL}
      - PINECONE_INDEX_NAME=${PINECONE_INDEX_NAME}

      # RAG System Configuration
      - RAG_CHUNK_SIZE=${RAG_CHUNK_SIZE}
      - RAG_CHUNK_OVERLAP=${RAG_CHUNK_OVERLAP}
      - RAG_RETRIEVAL_K=${RAG_RETRIEVAL_K}
      - RAG_SIMILARITY_THRESHOLD=${RAG_SIMILARITY_THRESHOLD}

      # External Services - Email Configuration (Frontend Only)
      - RESEND_API_KEY=${RESEND_API_KEY}
      - FROM_EMAIL=${FROM_EMAIL}
      - FROM_NAME=${FROM_NAME}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - REDIS_URL=${REDIS_URL}

      # API & Security Configuration
      - CORS_ORIGINS=${CORS_ORIGINS}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE}
      - UPLOAD_DIR=${UPLOAD_DIR}
      - API_V1_STR=${API_V1_STR}
      - PROJECT_NAME=${PROJECT_NAME}

      # Monitoring & Observability
      - PROMETHEUS_PORT=${PROMETHEUS_PORT}
      - GRAFANA_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GRAFANA_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GRAFANA_DOMAIN=${GRAFANA_DOMAIN}
      - GRAFANA_URL=${GRAFANA_URL}
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "8000:8000"
    dns:
      - 1.1.1.1
      - 1.0.0.1
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - tunarasa-net
    volumes:
      - uploads_data:/app/uploads
    healthcheck:
      test: ["CMD", "curl", "-f", "${NEXT_PUBLIC_BACKEND_URL}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # Redis Service (Caching & Sessions)
  redis:
    container_name: tunarasa-redis
    image: redis:7-alpine
    ports:
      - "6379:6379"
    dns:
      - 1.1.1.1
      - 1.0.0.1
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - redis_data_prod:/data
      - ../files/monitoring/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - tunarasa-net
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Nginx (Reverse Proxy & Load Balancer)
  # nginx:
  #   container_name: tunarasa-nginx
  #   image: nginx:alpine
  #   depends_on:
  #     frontend:
  #       condition: service_healthy
  #     backend:
  #       condition: service_healthy
  #   ports:
  #     # - "443:443" # production
  #     - "80:80"     # testing
  #   dns:
  #     - 1.1.1.1
  #     - 1.0.0.1
  #     - 8.8.8.8
  #     - 8.8.4.4
  #   networks:
  #     - tunarasa-net
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx/ssl:/etc/nginx/ssl:ro
  #     - nginx_logs:/var/log/nginx
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   restart: unless-stopped

  # Prometheus (Metrics Collection)
  prometheus:
    container_name: tunarasa-prometheus
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    dns:
      - 1.1.1.1
      - 1.0.0.1
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - tunarasa-net
    volumes:
      - ../files/monitoring/prometheus/prometheus.prod.yml:/etc/prometheus/prometheus.yml:ro
      - ../files/monitoring/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data_prod:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    restart: unless-stopped

  # Grafana (Monitoring Dashboard)
  grafana:
    container_name: tunarasa-grafana
    image: grafana/grafana:latest
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_DOMAIN=${GRAFANA_DOMAIN}
      - GF_SERVER_ROOT_URL=https://${GRAFANA_DOMAIN}
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    depends_on:
      - prometheus
    ports:
      - "3030:3000"
    dns:
      - 1.1.1.1
      - 1.0.0.1
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - tunarasa-net
    volumes:
      - grafana_data_prod:/var/lib/grafana
      - ../files/monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - ../files/monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    restart: unless-stopped

volumes:
  redis_data_prod:
    driver: local
  prometheus_data_prod:
    driver: local
  grafana_data_prod:
    driver: local
  uploads_data:
    driver: local
  nginx_logs:
    driver: local

networks:
  tunarasa-net:
    name: tunarasa-net
    driver: bridge

secrets:
  # Environment Configuration
  NODE_ENV:
    environment: NODE_ENV
  ENVIRONMENT:
    environment: ENVIRONMENT
  DEBUG:
    environment: DEBUG
  SITE_NAME:
    environment: SITE_NAME

  # Frontend Configuration (Next.js)
  NEXT_PUBLIC_APP_URL:
    environment: NEXT_PUBLIC_APP_URL
  NEXT_PUBLIC_BACKEND_URL:
    environment: NEXT_PUBLIC_BACKEND_URL
  NEXT_PUBLIC_API_URL:
    environment: NEXT_PUBLIC_API_URL
  BACKEND_URL:
    environment: BACKEND_URL
  NEXT_TELEMETRY_DISABLED:
    environment: NEXT_TELEMETRY_DISABLED
  NEXT_PRIVATE_STANDALONE:
    environment: NEXT_PRIVATE_STANDALONE

  # Database Configuration
  DATABASE_URL:
    environment: DATABASE_URL
  user:
    environment: user
  password:
    environment: password
  host:
    environment: host
  port:
    environment: port
  dbname:
    environment: dbname

  # Authentication & Security
  SECRET_KEY:
    environment: SECRET_KEY
  ACCESS_TOKEN_EXPIRE_MINUTES:
    environment: ACCESS_TOKEN_EXPIRE_MINUTES
  NEXT_PUBLIC_ENABLE_CLERK_AUTH:
    environment: NEXT_PUBLIC_ENABLE_CLERK_AUTH
  CLERK_SECRET_KEY:
    environment: CLERK_SECRET_KEY
  NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY:
    environment: NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
    
  # Clerk Configuration URLs
  NEXT_PUBLIC_CLERK_SIGN_IN_URL:
    environment: NEXT_PUBLIC_CLERK_SIGN_IN_URL
  NEXT_PUBLIC_CLERK_SIGN_UP_URL:
    environment: NEXT_PUBLIC_CLERK_SIGN_UP_URL
  NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL:
    environment: NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL
  NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL:
    environment: NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL

  # AI Services Configuration
  GROQ_API_KEY:
    environment: GROQ_API_KEY
  LLM_MODEL:
    environment: LLM_MODEL
  LLM_TEMPERATURE:
    environment: LLM_TEMPERATURE
  LLM_MAX_TOKENS:
    environment: LLM_MAX_TOKENS
  PINECONE_API_KEY:
    environment: PINECONE_API_KEY
  EMBEDDING_MODEL:
    environment: EMBEDDING_MODEL
  PINECONE_INDEX_NAME:
    environment: PINECONE_INDEX_NAME

  # RAG System Configuration
  RAG_CHUNK_SIZE:
    environment: RAG_CHUNK_SIZE
  RAG_CHUNK_OVERLAP:
    environment: RAG_CHUNK_OVERLAP
  RAG_RETRIEVAL_K:
    environment: RAG_RETRIEVAL_K
  RAG_SIMILARITY_THRESHOLD:
    environment: RAG_SIMILARITY_THRESHOLD

  # External Services - Email Configuration (Frontend Only)
  RESEND_API_KEY:
    environment: RESEND_API_KEY
  FROM_EMAIL:
    environment: FROM_EMAIL
  FROM_NAME:
    environment: FROM_NAME
  ADMIN_EMAIL:
    environment: ADMIN_EMAIL
  REDIS_URL:
    environment: REDIS_URL

  # API & Security Configuration
  CORS_ORIGINS:
    environment: CORS_ORIGINS
  ALLOWED_HOSTS:
    environment: ALLOWED_HOSTS
  RATE_LIMIT_REQUESTS:
    environment: RATE_LIMIT_REQUESTS
  RATE_LIMIT_WINDOW:
    environment: RATE_LIMIT_WINDOW
  MAX_FILE_SIZE:
    environment: MAX_FILE_SIZE
  UPLOAD_DIR:
    environment: UPLOAD_DIR
  API_V1_STR:
    environment: API_V1_STR
  PROJECT_NAME:
    environment: PROJECT_NAME

  # Monitoring & Observability
  PROMETHEUS_PORT:
    environment: PROMETHEUS_PORT
  GRAFANA_ADMIN_USER:
    environment: GRAFANA_ADMIN_USER
  GRAFANA_ADMIN_PASSWORD:
    environment: GRAFANA_ADMIN_PASSWORD
  GRAFANA_DOMAIN:
    environment: GRAFANA_DOMAIN
  GRAFANA_URL:
    environment: GRAFANA_URL
