FROM oven/bun:latest AS base

# Step 1. Install dependencies only when needed
FROM base AS deps

# Set working directory
WORKDIR /app

# Copy package.json and bun.lock
COPY package.json bun.lock ./

# Install dependencies
RUN bun install --frozen-lockfile

# Step 2. Rebuild the source code only when needed
FROM base AS builder

# Set working directory
WORKDIR /app

# Next.js collects completely anonymous telemetry data about general usage. Learn more here: https://nextjs.org/telemetry
# Uncomment the following line to disable telemetry at build time
ENV NEXT_TELEMETRY_DISABLED=1

# Next.js Standalone Mode
ENV NEXT_PRIVATE_STANDALONE=true

# Disable Clerk during build time to avoid Docker compatibility issues
ENV NEXT_PUBLIC_ENABLE_CLERK_AUTH=false

# Copy all files
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# Environment variables must be present at build time
# https://github.com/vercel/next.js/discussions/14030
# Inject secrets securely (BuildKit only!) & Build the application

    # Environment Configuration
RUN --mount=type=secret,id=NODE_ENV,env=NODE_ENV \
    --mount=type=secret,id=ENVIRONMENT,env=ENVIRONMENT \
    --mount=type=secret,id=DEBUG,env=DEBUG \
    --mount=type=secret,id=SITE_NAME,env=SITE_NAME \

    # Frontend Configuration (Next.js)
    --mount=type=secret,id=NEXT_PUBLIC_APP_URL,env=NEXT_PUBLIC_APP_URL \
    --mount=type=secret,id=NEXT_PUBLIC_BACKEND_URL,env=NEXT_PUBLIC_BACKEND_URL \
    --mount=type=secret,id=NEXT_PUBLIC_API_URL,env=NEXT_PUBLIC_API_URL \
    --mount=type=secret,id=BACKEND_URL,env=BACKEND_URL \
    --mount=type=secret,id=NEXT_TELEMETRY_DISABLED,env=NEXT_TELEMETRY_DISABLED \
    --mount=type=secret,id=NEXT_PRIVATE_STANDALONE,env=NEXT_PRIVATE_STANDALONE \

    # Database Configuration
    --mount=type=secret,id=DATABASE_URL,env=DATABASE_URL \
    --mount=type=secret,id=NEXT_PUBLIC_SUPABASE_URL,env=NEXT_PUBLIC_SUPABASE_URL \
    --mount=type=secret,id=NEXT_PUBLIC_SUPABASE_ANON_KEY,env=NEXT_PUBLIC_SUPABASE_ANON_KEY \
    --mount=type=secret,id=SUPABASE_SERVICE_ROLE_KEY,env=SUPABASE_SERVICE_ROLE_KEY \
    --mount=type=secret,id=user,env=user \
    --mount=type=secret,id=password,env=password \
    --mount=type=secret,id=host,env=host \
    --mount=type=secret,id=port,env=port \
    --mount=type=secret,id=dbname,env=dbname \

    # Authentication & Security
    --mount=type=secret,id=SECRET_KEY,env=SECRET_KEY \
    --mount=type=secret,id=ACCESS_TOKEN_EXPIRE_MINUTES,env=ACCESS_TOKEN_EXPIRE_MINUTES \
    --mount=type=secret,id=NEXT_PUBLIC_ENABLE_CLERK_AUTH,env=NEXT_PUBLIC_ENABLE_CLERK_AUTH \
    --mount=type=secret,id=NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY,env=NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY \
    --mount=type=secret,id=CLERK_SECRET_KEY,env=CLERK_SECRET_KEY \
    --mount=type=secret,id=CLERK_WEBHOOK_SIGNING_SECRET,env=CLERK_WEBHOOK_SIGNING_SECRET \
    --mount=type=secret,id=NEXT_PUBLIC_CLERK_SIGN_IN_URL,env=NEXT_PUBLIC_CLERK_SIGN_IN_URL \
    --mount=type=secret,id=NEXT_PUBLIC_CLERK_SIGN_UP_URL,env=NEXT_PUBLIC_CLERK_SIGN_UP_URL \
    --mount=type=secret,id=NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL,env=NEXT_PUBLIC_CLERK_SIGN_IN_FALLBACK_REDIRECT_URL \
    --mount=type=secret,id=NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL,env=NEXT_PUBLIC_CLERK_SIGN_UP_FALLBACK_REDIRECT_URL \

    # AI Services Configuration
    --mount=type=secret,id=GROQ_API_KEY,env=GROQ_API_KEY \
    --mount=type=secret,id=LLM_MODEL,env=LLM_MODEL \
    --mount=type=secret,id=LLM_TEMPERATURE,env=LLM_TEMPERATURE \
    --mount=type=secret,id=LLM_MAX_TOKENS,env=LLM_MAX_TOKENS \

    # RAG System Configuration
    --mount=type=secret,id=PINECONE_API_KEY,env=PINECONE_API_KEY \
    --mount=type=secret,id=PINECONE_INDEX_NAME,env=PINECONE_INDEX_NAME \
    --mount=type=secret,id=EMBEDDING_MODEL,env=EMBEDDING_MODEL \
    --mount=type=secret,id=RAG_CHUNK_SIZE,env=RAG_CHUNK_SIZE \
    --mount=type=secret,id=RAG_CHUNK_OVERLAP,env=RAG_CHUNK_OVERLAP \
    --mount=type=secret,id=RAG_RETRIEVAL_K,env=RAG_RETRIEVAL_K \
    --mount=type=secret,id=RAG_SIMILARITY_THRESHOLD,env=RAG_SIMILARITY_THRESHOLD \

    # External Services
    --mount=type=secret,id=RESEND_API_KEY,env=RESEND_API_KEY \
    --mount=type=secret,id=FROM_EMAIL,env=FROM_EMAIL \
    --mount=type=secret,id=FROM_NAME,env=FROM_NAME \
    --mount=type=secret,id=ADMIN_EMAIL,env=ADMIN_EMAIL \
    --mount=type=secret,id=REDIS_URL,env=REDIS_URL \

    # API & Security Configuration
    --mount=type=secret,id=CORS_ORIGINS,env=CORS_ORIGINS \
    --mount=type=secret,id=ALLOWED_HOSTS,env=ALLOWED_HOSTS \
    --mount=type=secret,id=RATE_LIMIT_REQUESTS,env=RATE_LIMIT_REQUESTS \
    --mount=type=secret,id=RATE_LIMIT_WINDOW,env=RATE_LIMIT_WINDOW \
    --mount=type=secret,id=MAX_FILE_SIZE,env=MAX_FILE_SIZE \
    --mount=type=secret,id=UPLOAD_DIR,env=UPLOAD_DIR \
    --mount=type=secret,id=API_V1_STR,env=API_V1_STR \
    --mount=type=secret,id=PROJECT_NAME,env=PROJECT_NAME \

    # Monitoring & Observability
    --mount=type=secret,id=PROMETHEUS_PORT,env=PROMETHEUS_PORT \
    --mount=type=secret,id=GRAFANA_ADMIN_USER,env=GRAFANA_ADMIN_USER \
    --mount=type=secret,id=GRAFANA_ADMIN_PASSWORD,env=GRAFANA_ADMIN_PASSWORD \
    --mount=type=secret,id=GRAFANA_DOMAIN,env=GRAFANA_DOMAIN \
    --mount=type=secret,id=GRAFANA_URL,env=GRAFANA_URL

# Build the application
RUN bun run build

# Step 3. Production image, copy all the files and run next
FROM base AS runner

# Set working directory
WORKDIR /app

# Create a non-root user
# RUN addgroup --system --gid 1001 bunjs
# RUN adduser --system --uid 1001 nextjs

# Group 'bun' is already installed in the base image 'oven/bun:latest'
RUN adduser --system --uid 1001 nextjs --ingroup bun

# Install necessary packages
RUN apt-get update && apt-get install -y \
    postgresql-client \
    curl \
    git \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Copy necessary files
COPY --from=builder --chown=nextjs:bun /app/public ./public
COPY --from=builder --chown=nextjs:bun /app/.next/standalone ./
COPY --from=builder --chown=nextjs:bun /app/.next/static ./.next/static

# Switch to non-root user
USER nextjs

# Next.js collects completely anonymous telemetry data about general usage. Learn more here: https://nextjs.org/telemetry
# Uncomment the following line to disable telemetry at build time
ENV NEXT_TELEMETRY_DISABLED=1

# Next.js Standalone Mode
ENV NEXT_PRIVATE_STANDALONE=true

# ENV hostname 0.0.0.0 & port 3000 'only for testing'
EXPOSE 3000
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Start the application
CMD ["bun", "run", "server.js"]
